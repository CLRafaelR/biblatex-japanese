% -*- mode: LaTeX -*-
\ProvidesFile{biblatex-japanese.def}

\catcode`\@=11
\def\blxja@macrosdefined{\blxja@macrosdefined}

\RequirePackage{xpatch}

\def\blxja@xpatchbibmacro#1#2#3{%
  \xpatchbibmacro{#1}{#2}{#3}{}{%
    \PackageWarning{biblatex-japanese}{Patching to the bibmacro `#1' failed}}}

\DeclareDocumentCommand{\DeclareJapaneseCommand}{ m m }{%
  \ifundef{#1}{%
    \PackageError{biblatex-japanese}{\DeclareJapaneseCommand for the command `#1' failed}%
  }{%
    \csdef{blxja@ja@\detokenize{#1}}{#2}%
    \cslet{blxja@orig@\detokenize{#1}}{#1}%
    \def#1{%
      \iffieldequalstr{langid}{japanese}
                      {\csuse{blxja@ja@\detokenize{#1}}}
                      {\csuse{blxja@orig@\detokenize{#1}}}}}}

\DeclareDocumentCommand{\DeclareJapaneseBibmacro}{ m m }{%
  \ifcsundef{abx@macro@\detokenize{#1}}{%
    \PackageError{biblatex-japanese}{\DeclareJapaneseBibmacro for the bibmacro `#1' failed}%
  }{%
    \csdef{abx@macro@blxja@ja@\detokenize{#1}}{#2}%
    \csletcs{abx@macro@blxja@orig@\detokenize{#1}}{abx@macro@\detokenize{#1}}%
    \csdef{abx@macro@\detokenize{#1}}{%
      \iffieldequalstr{langid}{japanese}
                      {\csuse{abx@macro@blxja@ja@\detokenize{#1}}}
                      {\csuse{abx@macro@blxja@orig@\detokenize{#1}}}}}}

\def\blxja@def@jamacro#1#2#3{%
  \DeclareDocumentCommand{#1}{ O{*} m m }{%
    \ifcsundef{#2@\detokenize{##1}@\detokenize{##2}}{%
      \PackageError{biblatex-japanese}{#1 for the name format `##2' failed}%
    }{%
      \csdef{#2@\detokenize{##1}@blxja@ja@\detokenize{##2}}#3{##3}%
      \csletcs{#2@\detokenize{##1}@blxja@orig@\detokenize{##2}}{#2@\detokenize{##1}@\detokenize{##2}}%
      \csdef{#2@\detokenize{##1}@\detokenize{##2}}{%
        \iffieldequalstr{langid}{japanese}
                        {\csuse{#2@\detokenize{##1}@blxja@ja@\detokenize{##2}}}
                        {\csuse{#2@\detokenize{##1}@blxja@orig@\detokenize{##2}}}}}}}

\blxja@def@jamacro{\DeclareJapaneseNameFormat}{abx@nfd}{##1##2##3##4##5##6##7##8}

\endinput
