% -*- mode: LaTeX -*-
\ProvidesFile{biblatex-japanese.def}

\catcode`\@=11
\def\blxja@macrosdefined{\blxja@macrosdefined}

\RequirePackage{xpatch}

\long\def\blxja@xpatchbibmacro@#1#2#3#4{#1{#2}{#3}{#4}{}{%
    \PackageWarning{biblatex-japanese}{Patching to the bibmacro `\string#2' failed}{}}}
\newrobustcmd*\blxja@xpatchbibmacro{%
  \etb@dbg@trce\blxja@xpatchbibmacro
  \begingroup
  \@makeother\#%
  \blxja@xpatchbibmacro@\etb@patchcmd}

\long\def\blxja@addjafork#1#2{%
  \unexpanded{\unexpanded{\unexpanded{\iffieldequalstr}}}{langid}{japanese}{#2}{#1}}

\long\def\blxja@djc@#1#2#3#4{#1#2{#3}{#4}{}{%
    \PackageError{biblatex-japanese}
                 {\DeclareJapaneseCommand for the command `\string#3' failed}{}}}
\DeclareDocumentCommand{\DeclareJapaneseCommand}{}{%
  \etb@dbg@trce\DeclareJapaneseCommand
  \begingroup
  \@makeother\#%
  \blxja@djc@\etb@hooktocmd\blxja@addjafork}

\long\def\blxja@djb@#1#2#3#4{%
  \expandafter#1\expandafter#2\expandafter{\csname abx@macro@#3\endcsname}{#4}{}{%
    \PackageError{biblatex-japanese}{\DeclareJapaneseBibmacro for the bibmacro `\detokenize{#3}' failed}{}}}
\DeclareDocumentCommand{\DeclareJapaneseBibmacro}{}{%
  \etb@dbg@trce\DeclareJapaneseBibmacro
  \begingroup
  \@makeother\#%
  \blxja@djb@\etb@hooktocmd\blxja@addjafork}

\def\blxja@def@declarejamacro#1#2#3{%
  \DeclareDocumentCommand{#2}{ O{*} m m }{%
    \ifcsundef{#1@\detokenize{##1}@\detokenize{##2}}{%
      \PackageError{biblatex-japanese}{#2 for the name format `##2' failed}{}%
    }{%
      \csdef{#1@\detokenize{##1}@blxja@ja@\detokenize{##2}}#3{##3}%
      \csletcs{#1@\detokenize{##1}@blxja@orig@\detokenize{##2}}{#1@\detokenize{##1}@\detokenize{##2}}%
      \csdef{#1@\detokenize{##1}@\detokenize{##2}}{%
        \iffieldequalstr{langid}{japanese}
                        {\csuse{#1@\detokenize{##1}@blxja@ja@\detokenize{##2}}}
                        {\csuse{#1@\detokenize{##1}@blxja@orig@\detokenize{##2}}}}}}}

\blxja@def@declarejamacro{abx@nfd}{\DeclareJapaneseNameFormat}{##1##2##3##4##5##6##7##8}

\endinput
