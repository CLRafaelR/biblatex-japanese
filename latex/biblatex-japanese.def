% -*- mode: LaTeX -*-
\ProvidesFile{biblatex-japanese.def}

\edef\blxja@restorecatcode{\catcode64=\the\catcode64}
\catcode`\@=11
\def\blxja@macrosdefined{\blxja@macrosdefined}

%% --- Internal macros ---
\def\blxja@error#1#2{\PackageError{biblatex-japanese}{#1}{#2}}
\def\blxja@warning#1{\PackageWarning{biblatex-japanese}{#1}}
\def\blxja@warning@noline#1{\PackageWarningNoLine{biblatex-japanese}{#1}}

%% --- User commands ---
\DeclareDocumentCommand{\replacecommand}{ s }{%
  \IfBooleanTF{#1}
              {\blxja@replacecommand@rulecode}
              {\blxja@replacecommand@rulename}}
\def\blxja@replacecommand@rulename{%
  \etb@dbg@trce\replacecommand
  \begingroup
  \@makeother\#%
  \blxja@rcrn@args}
\def\blxja@replacecommand@rulecode{%
  \etb@dbg@trce{\replacecommand*}
  \begingroup
  \@makeother\#%
  \blxja@rcrc@args}
\long\def\blxja@rcrn@args#1#2#3{%
  \ifcsundef{blxja@replacerule@\detokenize{#2}}{%
    \blxja@error{Replace rule '\detokenize{#2}' undefined}{}}{%
    \expandafter\etb@hooktocmd\csname blxja@replacerule@\detokenize{#2}\endcsname#1{#3}{}{%
      \blxja@error{\replacecommand for the command \string#1 failed}
                  {Try \detokenize{\tracingpatches} to investigate the cause of the problem.\MessageBreak}}}}
\long\def\blxja@rcrc@args#1#2#3{%
  \endgroup
  \edef\blxja@reserveda{%
    \unexpanded{\protected\long\def\blxja@replacerule@@temprule@##1##2}{%
      \scantokens{\unexpanded{#2}\noexpand}}}%
  \blxja@reserveda
  \begingroup                  % dummy for \endgroup in \etb@hooktocmd
  \blxja@rcrn@args#1{@temprule@}{#3}}

\DeclareDocumentCommand{\replacebibmacro}{ s }{%
  \IfBooleanTF{#1}
              {\blxja@replacebibmacro@rulecode}
              {\blxja@replacebibmacro@rulename}}
\def\blxja@replacebibmacro@rulename{%
  \etb@dbg@trce\replacebibmacro
  \begingroup
  \@makeother\#%
  \blxja@rbrn@args}
\def\blxja@replacebibmacro@rulecode{%
  \etb@dbg@trce{\replacebibmacro*}
  \begingroup
  \@makeother\#%
  \blxja@rbrc@args}
\long\def\blxja@rbrn@args#1#2#3{%
  \endgroup
  \ifcsundef{blxja@replacerule@\detokenize{#2}}{%
    \blxja@error{Replace rule '\detokenize{#2}' undefined}{}}{%
    \expandafter\def\expandafter\blxja@tempa\expandafter{\csname blxja@replacerule@\detokenize{#2}\endcsname}%
    \expandafter\def\expandafter\blxja@tempb\expandafter{\csname abx@macro@\detokenize{#1}\endcsname}%
    \begingroup                % dummy for \endgroup in \etb@hooktocmd
    \expandafter\expandafter\expandafter\etb@hooktocmd\expandafter\blxja@tempa\blxja@tempb{#3}{}{%
      \blxja@error{\replacebibmacro for the bibliography macro '\detokenize{#1}' failed}
                  {Try \detokenize{\tracingpatches} to investigate the cause of the problem.\MessageBreak}}}}
\long\def\blxja@rbrc@args#1#2#3{%
  \endgroup
  \edef\blxja@reserveda{%
    \unexpanded{\protected\long\def\blxja@replacerule@@temprule@##1##2}{%
      \scantokens{\unexpanded{#2}\noexpand}}}%
  \blxja@reserveda
  \begingroup                  % dummy for \endgroup in \etb@hooktocmd
  \blxja@rbrn@args{#1}{@temprule@}{#3}}

\DeclareDocumentCommand{\newreplacerule}{ m }{%
  \ifcsdef{blxja@replacerule@\detokenize{#1}}{%
    \blxja@warning{%
      Replace rule '\detokenize{#1}' already defined.\MessageBreak
      Using \string\renewreplacerule}}{}%
  \blxja@def@replacerule{#1}}

\DeclareDocumentCommand{\renewreplacerule}{ m }{%
  \ifcsundef{blxja@replacerule@\detokenize{#1}}{%
    \blxja@warning{%
      Replace rule '\detokenize{#1}' undefined.\MessageBreak
      Using \string\newreplacerule}}{}%
  \blxja@def@replacerule{#1}}

\def\blxja@def@replacerule#1#2{%
  \protected\long\csdef{blxja@replacerule@\detokenize{#1}}##1##2{#2}}

\newreplacerule{iflangidisjapanese}{%
  \iffieldequalstr{langid}{japanese}
                  {#2}
                  {#1}}

%% obsolete
\long\def\blxja@djc@args@#1#2#3#4{#1#2{#3}{#4}{}{%
    \blxja@error{\DeclareJapaneseCommand for the command \string#3 failed}
                {Try \detokenize{\tracingpatches} to investigate the cause of the problem.^^J}}}
\DeclareDocumentCommand{\DeclareJapaneseCommand}{}{%
  \etb@dbg@trce\DeclareJapaneseCommand
  \begingroup
  \@makeother\#%
  \blxja@djc@args@\etb@hooktocmd\blxja@replacerule@iflangidisjapanese}

\long\def\blxja@djb@args@#1#2#3#4{\expandafter
  #1\expandafter
  #2\expandafter
  {\csname abx@macro@\detokenize{#3}\endcsname}
  {#4}
  {}
  {\blxja@error
    {\DeclareJapaneseBibmacro for the bibliography macro '\detokenize{#3}' failed}
    {Try \detokenize{\tracingpatches} to investigate the cause of the problem.^^J^^J}}}
\DeclareDocumentCommand{\DeclareJapaneseBibmacro}{}{%
  \etb@dbg@trce\DeclareJapaneseBibmacro
  \begingroup
  \@makeother\#%
  \blxja@djb@args@\etb@hooktocmd\blxja@replacerule@iflangidisjapanese}

\def\blxja@def@declarejamacro#1#2#3{%
  \expandafter\DeclareDocumentCommand\expandafter
      {\csname blxja@\detokenize{#1}@args@\endcsname}
      { m m O{*} m +m }{\expandafter
        ##1\expandafter
        ##2\expandafter
        {\csname \detokenize{#1}@\detokenize{##3}@\detokenize{##4}\endcsname}
        {##5}
        {}
        {\blxja@error
          {#3 for the #2 '\detokenize{##4}' failed}
          {Try \detokenize{\tracingpatches} to investigate the cause of the problem.^^J^^J}}}
  \DeclareDocumentCommand{#3}{}{%
    \etb@dbg@trce#3
    \begingroup
    \@makeother\#%
    \csuse{blxja@\detokenize{#1}@args@}\etb@hooktocmd\blxja@replacerule@iflangidisjapanese}}

\blxja@def@declarejamacro{abx@nfd}{name format}{\DeclareJapaneseNameFormat}

%% --- Bibmacros for Japanese ---
\newbibmacro*{name:japanese-full}[4]{% test: now only remove spaces
  \usebibmacro{name:delim}{#2#3#1}%
  \usebibmacro{name:hook}{#2#3#1}%
  \ifblank{#2}{}{\mkbibnamefirst{#2}\isdot}%
  \ifblank{#3}{}{%
    \mkbibnameprefix{#3}\isdot}%
  \mkbibnamelast{#1}\isdot
  \ifblank{#4}{}{\bibnamedelimd\mkbibnameaffix{#4}\isdot}}

\newbibmacro*{name:japanese-last}[4]{% test
  \ifuseprefix
    {\usebibmacro{name:delim}{#2}%
     \usebibmacro{name:hook}{#2}%
     \ifblank{#2}
       {}
       {\ifcapital
          {\mkbibnameprefix{\MakeCapital{#2}}\isdot}
          {\mkbibnameprefix{#2}\isdot}%
        \ifprefchar{}{\bibnamedelimc}}}
    {\usebibmacro{name:delim}{#2}%
     \usebibmacro{name:hook}{#2}}%
  \mkbibnamelast{#2}\isdot}

\blxja@restorecatcode
\endinput
