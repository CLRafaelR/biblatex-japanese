\documentclass[lualatex,ja=standard,magstyle=real]{bxjsarticle}
\usepackage{etoolbox}
\usepackage{btxdockit}
\makeatletter
\patchcmd{\@maketitle}{\@author}{\setcounter{footnote}{1}\@author}{}{}
\patchcmd{\ltxsyntax}{\let}{\parindent=1\zw\let}{}{}
%% from ltxdockit.cfg
\renewcommand*{\verbatimfont}{\ttfamily}
\renewcommand*{\displayverbfont}{\ttfamily}
\renewcommand*{\marglistfont}{\spotcolor\sffamily\small}
\renewcommand*{\margnotefont}{\sffamily\small}
\renewcommand*{\optionlistfont}{\spotcolor\sffamily\displayverbfont}
\renewcommand*{\ltxsyntaxfont}{\ttfamily}
\renewcommand*{\ltxsyntaxlabelfont}{\spotcolor\displayverbfont}
\renewcommand*{\changelogfont}{\normalfont}
\renewcommand*{\changeloglabelfont}{\spotcolor\sffamily\bfseries}

\setmainjfont[BoldFont=M+ 1c-Bold]{IPAexMincho}
\setsansjfont{M+ 1c-Bold}
\setmainfont[BoldFont=M+ 1c-Bold]{TeXGyreTermes}
\setsansfont{M+ 1c-Bold}
\setmonofont{Inconsolata-zi4}
\renewcommand{\headfont}{\sffamily\spotcolor}
\pretocmd{\l@subsection}{\fontspec{M+ 1c-Regular}\jfontspec{M+ 1c-Regular}}{}{}
\renewcommand{\@makefnmark}{\hbox{}\hbox{\@textsuperscript{\normalfont\@thefnmark}}\hbox{}}
\makeatother

\title{\bfseries\spotcolor\sty{biblatex-japanese}パッケージ}
\author{前田一貴\footnote{Email: \texttt{kmaeda@kmaeda.net}}}
\hypersetup{%
  pdftitle={biblatex-japaneseパッケージ},
  pdfauthor={前田一貴},
  unicode,
  hypertexnames=false,
  colorlinks,
  citecolor=spot,
  linkcolor=spot,
  urlcolor=spot}

\begin{document}
\maketitle

\tableofcontents

\section{はじめに}

\subsection{動機と目標}
\LaTeX においては文献引用の煩雑な作業の効率化のためにBib\TeX がよく用いられている．
Bib\TeX を使うと，文献データベースを作成しておき，本文中の引用が必要な箇所に
\cmd{cite}コマンドを書くだけで自動的に，指定したスタイルでソートされた文献リストが
指定箇所に，ソート後の文献番号が本文中の引用箇所に出力される．Bib\TeX は特に
参考文献が膨大な数に及ぶ書籍や論文の執筆には欠かせない機構であるが，文献リストの
スタイルを指定する\file{.bst}ファイルの作成には独自言語
\footnote{PostScriptと同様の postfix stack-based programming language,
  いわゆる逆ポーランド記法に基づいた言語であり，不慣れな者には扱い難い．}
を用いなければならず，指定された様式に沿う\file{.bst}ファイルが用意されて
いない場合には門外漢には利用が困難であるという問題があった．

この困難の緩和を目的の一つとして，近年になって
\sty{biblatex}\footnote{\url{https://github.com/plk/biblatex}}というパッケージが
開発されている．
\sty{biblatex}は文献のソートに\file{biber}と呼ばれるPerlスクリプトを用いる
以外は全て\TeX{}のマクロで記述されており，カスタマイズが（Bib\TeX に比べると）
容易になっている．また\sty{biblatex}では，従来は別のパッケージで提供されていた，
脚注への文献情報の出力や章毎の文献リストの出力といった，人文系で要求されることの
多い機能が充実しており\footnote{おそらく\file{.bst}が云々よりもこちらが移行する
  理由としては大きいと思われる．}，欧米の人文系学界ではBib\TeX に代わるものとして
普及が進んでいるとされている\footnote{本当かどうかはちゃんと調べていないので知らない．}．
しかし，\sty{biblatex}では和文における利用は現状全く考慮されていないため，
日本国内では需要があるにも関わらずあまり活用されていないようである．需要に対して
供給がない理由は，日本の\LaTeX 利用者の多くが理科系の人間であり，理科系においては
論文といえば多くが英文によるものであること，理科系の和文論文を書く場合にもBib\TeX
の機能で事足りてしまうといったことがあると考えられる．

そこで，こうした問題に対処するために，\sty{biblatex-japanese}というパッケージを
作るプロジェクトを立ち上げることにした．「パッケージを作る」とは書いたが，立ち上げ
時点では着地点がどこになるかはまだ定かではない．\sty{biblatex}を使わなくとも
Bib\TeX で問題を解決することも可能であるという話もある
\footnote{\url{https://twitter.com/munepixyz/status/663199507392237568}}ので，
そうしたノウハウを集めて形にするといったことも目標として考えられる．いずれにせよ，
これを書いている人（前田）自身は理科系の人間であるため，具体的にどういう要望がある
のかを集約することが喫緊の課題であると考えている．

おぼろげながら考えているロードマップ（と呼べるほどのものではないが）は以下のようである．
\begin{enumerate}
\item GitHubのIssue機能などを用いて要望を集める．
\item コードを書いて要望を実現する．ベースとしては\sty{biblatex}や
  \sty{biblatex-chicago}を用い，和文での文献引用における様々なニーズに柔軟に
  対応できるようなフレームワークを用意することを目指す．
\item 成果物はCTANにアップロードし，\TeX{} Liveをインストールするだけで利用可能にする．
\end{enumerate}

\subsection{ライセンス}
二条項BSDライセンスとする．同梱の\file{LICENSE}を参照し，従うこと．

\subsection{バグレポート・要望など}
パッケージの開発にはGitHub\footnote{\url{https://github.com/kmaed/biblatex-japanese}}を利用している．
バグレポートや要望はここのIssuesに書き込めば，対応可能である（もちろん日本語で構わない）．
また，パッチを投げるにはPull requestsが利用できる．

GitHubが利用できない場合は，メールで報告していただいても構わない．メールアドレスは最初のページの脚注に書いてある．

\subsection{謝辞}


\section{使い方}
\sty{biblatex-japanese}一式を\file{TEXMF}ツリーの適切な場所に配置したうえで，
プリアンブルに次を入れる：
\begin{lstlisting}[style=latex]{}
\usepackage[backend=biber]{biblatex-japanese}
\end{lstlisting}
これで\sty{biblatex}本体および日本語用の設定ファイルが読み込まれる．
\sty{biblatex}に渡したいオプションは\sty{biblatex-japanese}に渡せばよい．
例えば，引用時の番号をソートしたければ
\begin{lstlisting}[style=latex]{}
\usepackage[backend=biber,sortcites=true]{biblatex-japanese}
\end{lstlisting}
のようにする．

\sty{biblatex-chicago}を読み込みたいときは
\begin{lstlisting}[style=latex]{}
\usepackage[backend=biber,chicago]{biblatex-japanese}
\end{lstlisting}
と\opt{chicago}オプションをつける．
このときは，\sty{biblatex-chicago}に渡すオプションも通るようになる．

\paragraph{注意}
まだまだ開発は始めたばかりのため，とても実用に耐えるものではない．
気長に待っていただければ幸いである．

\section{開発者向けコマンド解説}
\sty{biblatex-japanese}では，日本語対応ファイルの開発に用いるコマンド（マクロ）を
\file{biblatex-japanese.def}というファイルの中に記述している．
使用例は\file{japanese.lbx}内で見つけられるだろう．

なお，以下に説明するコマンドの名前・文法・仕様はまだ流動的であり，
今後のバージョンで変更がある可能性が高いので注意を要する．

\subsection{日本語部分のコードを置換するコマンド}

\begin{ltxsyntax}
  \cmditem{DeclareJapaneseCommand}{command}{code for Japanese}

  \prm{command}が文献出力処理中に現れたとき，もしその文献の
  \bibfield{langid}が\opt{japanese}ならば\prm{code for Japanese}に
  置き換わり，そうでなければ元々のコマンドになる．

  ただし，「\bibfield{langid}が\opt{japanese}」という条件はあまり筋がよくない
  ように思うので，そのうち変更される可能性がある．

  \cmditem{DeclareJapaneseBibmacro}{name}{code for Japanese}

  \cmditem{DeclareJapaneseNameFormat}[entrytype, \dots]{format}{code for Japanese}

  それぞれ\cmd{DeclareJapaneseCommand}のbibmacro, name list formatに対応するもの．
\end{ltxsyntax}

\paragraph{使用上の注意点}
\cmd{DefineBibliographyExtras}などの引数内で使用する場合は注意が必要である．
以下でこのことについて説明する．

一連の\prm{code for Japanese}に置換するコマンドは\sty{etoolbox}パッケージ
\footnote{\url{https://github.com/josephwright/etoolbox}}の
パッチコマンドを用いて実装されている．このパッチコマンドはパラメータ文字
（\texttt{\#1}など）を取り扱うために，一度\texttt{\#}のカテゴリコードを12 (other)に
変えてから引数のコードを取り込み，後で\cmd{scantokens}で読み直すという処理を行っている．
このため，引数のコードを一度別のマクロに保存してから実行するような処理と相性が悪い．
このことを理解するには次のコードを試してみるとよい：
\begin{lstlisting}[style=latex]{}
\def\a#1{\detokenize{#1}}
\a{#2}
\end{lstlisting}
処理すると結果は「\#\#2」となるはずである．このように二重\texttt{\#}に化けてから
パッチコマンドに渡すと，うまくパッチが当てられないということになる．
この現象と同じことが\cmd{DeclareBibliographyExtras}や
\cmd{DefineBibliographyExtras}などの引数にパラメータ文字を含む
\prm{code for Japanese}を持つ置換コマンドを与えた場合に起こり，パッチ処理が
失敗するという結果になる．

この問題の回避策としては，前もって\texttt{\#}のカテゴリコードを12 (other)に変えて
しまうという方法がある．実例は\file{japanese.lbx}にある．もちろん，問題部分を
読み取らせた後はカテゴリコードを元に戻す必要がある．なお，置換コマンド以外
（定義関係のコマンド）の引数で\texttt{\#}を含むものがある場合は，
カテゴリコード12で読ませると当然意図通りにならないので，この場合は処理を
分割する必要がある．
\end{document}
